<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickServe - Provider Profile</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>‚ö° QuickServe</h1>
    <p>My Profile</p>
    <nav>
      <a href="sp_dashboard.html">Home</a>
      <a href="sp_bookings.html">Bookings</a>
      <a href="sp_availability.html">Availability</a>
      <a href="sp_profile.html">Profile</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </nav>
  </header>

  <main class="auth-container">
    <form id="profileForm">
      <h2>Edit Profile</h2>
      
      <label>Full Name</label>
      <input type="text" id="profileName" placeholder="Enter your name" required />

      <label>Email</label>
      <input type="email" id="profileEmail" placeholder="Enter email" readonly />

      <label>Phone Number</label>
      <input type="tel" id="profilePhone" placeholder="Enter phone number" required />

      <label>Service Type</label>
      <select id="profileServiceType" required>
        <option value="Electrician">Electrician</option>
        <option value="Plumber">Plumber</option>
        <option value="Cleaner">Cleaner</option>
        <option value="Painter">Painter</option>
        <option value="Carpenter">Carpenter</option>
        <option value="AC Repair">AC Repair</option>
      </select>

      <label>Experience (Years)</label>
      <input type="number" id="profileExperience" placeholder="Years of experience" required min="0" />

      <label>Service Area</label>
      <input type="text" id="profileArea" placeholder="e.g., Mumbai, Delhi" required />

      <label>About / Bio</label>
      <textarea id="profileBio" placeholder="Tell customers about your services..." rows="3"></textarea>

      <button type="submit" class="btn-primary">Update Profile</button>
    </form>
  </main>

  <footer>
    <p>¬© 2025 QuickServe. All rights reserved.</p>
  </footer>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const user = getLoggedInUser();
      if (!user || user.role !== 'sp') {
        window.location.href = 'sp_login.html';
        return;
      }

      // Load profile
      await loadProfile();

      // Setup logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (confirm('Are you sure you want to logout?')) {
            logoutUser();
          }
        });
      }

      // Handle profile form submission
      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateProviderProfile();
      });
    });

    async function loadProfile() {
      const user = getLoggedInUser();
      
      try {
        const provider = await apiGet(`${API_CONFIG.ENDPOINTS.PROVIDERS}/${user.email}`);
        
        console.log('Loaded provider:', provider);
        
        if (provider) {
          document.getElementById('profileName').value = provider.name || '';
          document.getElementById('profileEmail').value = provider.email || '';
          document.getElementById('profilePhone').value = provider.phone || '';
          document.getElementById('profileServiceType').value = provider.serviceType || 'Electrician';
          document.getElementById('profileExperience').value = provider.experience || '';
          document.getElementById('profileArea').value = provider.area || '';
          document.getElementById('profileBio').value = provider.bio || '';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('‚ùå Error loading profile data');
      }
    }

    async function updateProviderProfile() {
      const user = getLoggedInUser();
      const updatedData = {
        name: document.getElementById('profileName').value.trim(),
        email: user.email, // Keep existing email
        password: '', // Don't change password (backend should ignore if empty)
        phone: document.getElementById('profilePhone').value.trim(),
        serviceType: document.getElementById('profileServiceType').value,
        experience: parseInt(document.getElementById('profileExperience').value),
        area: document.getElementById('profileArea').value.trim(),
        bio: document.getElementById('profileBio').value.trim()
      };

      console.log('Updating profile with:', updatedData);

      try {
        const response = await apiPut(`${API_CONFIG.ENDPOINTS.PROVIDERS}/${user.email}`, updatedData);
        
        console.log('Update response:', response);
        
        if (response.status === 'success') {
          // Update session with new name
          setLoggedInUser(user.role, user.email, updatedData.name);
          alert('‚úÖ Profile updated successfully!');
          window.location.reload();
        } else {
          alert('‚ùå Update failed: ' + (response.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Profile update error:', error);
        alert('‚ùå Error updating profile. Please check console for details.');
      }
    }
  </script>
</body>
</html>