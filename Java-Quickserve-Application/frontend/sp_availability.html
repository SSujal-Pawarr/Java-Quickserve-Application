<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickServe - Manage Availability</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>⚡ QuickServe</h1>
    <p>Manage Availability</p>
    <nav>
      <a href="sp_dashboard.html">Home</a>
      <a href="sp_bookings.html">Bookings</a>
      <a href="sp_availability.html">Availability</a>
      <a href="sp_profile.html">Profile</a>
      <a href="#" id="logoutBtn">🚪 Logout</a>
    </nav>
  </header>

  <main class="auth-container">
    <form id="availabilityForm">
      <h2>Set Your Availability</h2>
      
      <label>Current Status</label>
      <select id="availabilityStatus" required>
        <option value="Available">Available</option>
        <option value="Busy">Busy</option>
        <option value="On Leave">On Leave</option>
      </select>

      <label>Working Days</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="workDays" value="Monday" /> Monday</label>
        <label><input type="checkbox" name="workDays" value="Tuesday" /> Tuesday</label>
        <label><input type="checkbox" name="workDays" value="Wednesday" /> Wednesday</label>
        <label><input type="checkbox" name="workDays" value="Thursday" /> Thursday</label>
        <label><input type="checkbox" name="workDays" value="Friday" /> Friday</label>
        <label><input type="checkbox" name="workDays" value="Saturday" /> Saturday</label>
        <label><input type="checkbox" name="workDays" value="Sunday" /> Sunday</label>
      </div>

      <label>Working Hours (From)</label>
      <input type="time" id="workStart" value="09:00" required />

      <label>Working Hours (To)</label>
      <input type="time" id="workEnd" value="18:00" required />

      <label>Service Radius (km)</label>
      <input type="number" id="serviceRadius" value="10" min="1" max="50" required />

      <button type="submit" class="btn-primary">Update Availability</button>
    </form>
  </main>

  <footer>
    <p>© 2025 QuickServe. All rights reserved.</p>
  </footer>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const user = getLoggedInUser();
      if (!user || user.role !== 'sp') {
        window.location.href = 'sp_login.html';
        return;
      }

      await loadAvailability();
      setupLogout();

      document.getElementById('availabilityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveAvailability();
      });
    });

    async function loadAvailability() {
      const user = getLoggedInUser();
      
      try {
        console.log('Loading availability for:', user.email);
        const provider = await apiGet(`${API_CONFIG.ENDPOINTS.PROVIDERS}/${user.email}`);
        
        console.log('Provider data:', provider);
        
        if (provider) {
          document.getElementById('availabilityStatus').value = provider.availabilityStatus || 'Available';
          document.getElementById('workStart').value = provider.workStart || '09:00';
          document.getElementById('workEnd').value = provider.workEnd || '18:00';
          document.getElementById('serviceRadius').value = provider.serviceRadius || 10;
          
          if (provider.workDays) {
            const workDays = provider.workDays.split(',');
            document.querySelectorAll('input[name="workDays"]').forEach(checkbox => {
              checkbox.checked = workDays.includes(checkbox.value);
            });
          } else {
            // Default: Monday to Friday
            ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => {
              const checkbox = document.querySelector(`input[name="workDays"][value="${day}"]`);
              if (checkbox) checkbox.checked = true;
            });
          }
        }
      } catch (error) {
        console.error('Error loading availability:', error);
        alert('❌ Error loading availability data');
      }
    }

    async function saveAvailability() {
      const user = getLoggedInUser();
      const workDays = Array.from(document.querySelectorAll('input[name="workDays"]:checked'))
        .map(cb => cb.value)
        .join(',');

      if (!workDays) {
        alert('⚠️ Please select at least one working day!');
        return;
      }

      const availabilityData = {
        status: document.getElementById('availabilityStatus').value,
        workDays: workDays,
        workStart: document.getElementById('workStart').value,
        workEnd: document.getElementById('workEnd').value,
        serviceRadius: parseInt(document.getElementById('serviceRadius').value)
      };

      console.log('Saving availability:', availabilityData);

      try {
        const response = await apiPut(`${API_CONFIG.ENDPOINTS.PROVIDERS}/${user.email}/availability`, availabilityData);
        
        console.log('Save response:', response);
        
        if (response.status === 'success') {
          alert('✅ Availability updated successfully!');
        } else {
          alert('❌ Update failed: ' + (response.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving availability:', error);
        alert('❌ Error updating availability. Please check console for details.');
      }
    }

    function setupLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (confirm('Are you sure you want to logout?')) {
            logoutUser();
          }
        });
      }
    }
  </script>
</body>
</html>