<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickServe - My Profile</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>⚡ QuickServe</h1>
    <p>My Profile</p>
    <nav>
      <a href="user_dashboard.html">Home</a>
      <a href="user_browse_services.html">Services</a>
      <a href="user_bookings.html">My Bookings</a>
      <a href="user_profile.html">Profile</a>
      <a href="#" id="logoutBtn">🚪 Logout</a>
    </nav>
  </header>

  <main class="auth-container">
    <form id="profileForm">
      <h2>Edit Profile</h2>
      
      <label>Full Name</label>
      <input type="text" id="profileName" placeholder="Enter full name" required />

      <label>Email</label>
      <input type="email" id="profileEmail" placeholder="Enter email" readonly />

      <label>Phone Number</label>
      <input type="tel" id="profilePhone" placeholder="Enter phone number" required />

      <label>Default Address</label>
      <textarea id="profileAddress" placeholder="Enter your address" rows="3"></textarea>

      <button type="submit" class="btn-primary">Update Profile</button>
    </form>
  </main>

  <footer>
    <p>© 2025 QuickServe. All rights reserved.</p>
  </footer>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const user = getLoggedInUser();
      if (!user || user.role !== 'user') {
        window.location.href = 'user_login.html';
        return;
      }

      await loadProfile();
      setupLogout();

      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateUserProfile();
      });
    });

    async function loadProfile() {
      const user = getLoggedInUser();
      
      try {
        console.log('Loading profile for:', user.email);
        const userDetails = await apiGet(`${API_CONFIG.ENDPOINTS.USERS}/${user.email}`);
        
        console.log('User details:', userDetails);
        
        if (userDetails) {
          document.getElementById('profileName').value = userDetails.name || '';
          document.getElementById('profileEmail').value = userDetails.email || '';
          document.getElementById('profilePhone').value = userDetails.phone || '';
          document.getElementById('profileAddress').value = userDetails.address || '';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('❌ Error loading profile data');
      }
    }

    async function updateUserProfile() {
      const user = getLoggedInUser();
      const updatedData = {
        name: document.getElementById('profileName').value.trim(),
        email: user.email, // Keep existing email
        password: '', // Don't change password
        phone: document.getElementById('profilePhone').value.trim(),
        address: document.getElementById('profileAddress').value.trim()
      };

      console.log('Updating profile with:', updatedData);

      try {
        const url = `${API_CONFIG.BASE_URL}/users/${user.email}`;
        console.log('Update URL:', url);
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData)
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Update response:', data);
        
        if (data.status === 'success') {
          // Update session with new name
          setLoggedInUser(user.role, user.email, updatedData.name);
          alert('✅ Profile updated successfully!');
          window.location.reload();
        } else {
          alert('❌ Update failed: ' + (data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Profile update error:', error);
        alert('❌ Error: ' + error.message + '\nCheck console for details.');
      }
    }

    function setupLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (confirm('Are you sure you want to logout?')) {
            logoutUser();
          }
        });
      }
    }
  </script>
</body>
</html>